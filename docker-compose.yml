services:
  ollama:
    image: ollama/ollama:latest
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
    container_name: ollama
    restart: always
    ports:
    - 127.0.0.1:11434:11434
    volumes:
    - ollama:/root/.ollama
    networks:
    - llm_network
    environment:
    - ENABLE_STREAMING_RESPONSE=true
    - STREAM_TIMEOUT=0
    - DEFAULT_MODELS_STREAM=true
    - LITELLM_PERSISTENT_CONNECTIONS=true
    - LITELLM_CONNECTION_POOL_SIZE=20
    - HTTPX_HTTP2=1
    - OLLAMA_NUM_PARALLEL=4
    - OLLAMA_MAX_LOADED_MODELS=2
    - OLLAMA_HOST=0.0.0.0:11434
    dns: &id001
    - 1.1.1.1
    - 8.8.8.8
    - 1.0.0.1
  open-webui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: open-webui
    labels:
    - com.centurylinklabs.watchtower.enable=true
    restart: always
    ports:
    - 127.0.0.1:3000:8080
    volumes:
    - open-webui:/app/backend/data
    networks:
    - llm_network
    environment:
    - ENABLE_STREAMING_RESPONSE=true
    - STREAM_TIMEOUT=0
    - DEFAULT_MODELS_STREAM=true
    - LITELLM_PERSISTENT_CONNECTIONS=true
    - LITELLM_CONNECTION_POOL_SIZE=20
    - HTTPX_HTTP2=1
    - OPENAI_API_BASE_URL=http://litellm-proxy:4000/v1
    - OPENAI_API_KEY=sk-Mwo8Vu-yqtdy2yssBiXAtg
    - OLLAMA_BASE_URL=http://litellm-proxy:4000
    - USE_OLLAMA_DOCKER=false
    - ENABLE_OLLAMA_API=true
    - LITELLM_MASTER_KEY=DkGrEz6oJvunUmnbNYKBATEW9nRP6GbF192RA9moeOc=
    - LITELLM_SALT_KEY=S4Mho07/pPwkNfn80qzujQ==
    - WEBUI_SECRET_KEY=056a8ba01c4c225d10a2746a4e95ab012b8103aec33b02f921c2825390d4232d
    depends_on:
    - ollama
    - litellm-proxy
    dns: *id001
  litellm-db:
    image: postgres:16
    container_name: litellm-db
    labels:
    - com.centurylinklabs.watchtower.enable=true
    restart: always
    environment:
    - ENABLE_STREAMING_RESPONSE=true
    - STREAM_TIMEOUT=0
    - DEFAULT_MODELS_STREAM=true
    - LITELLM_PERSISTENT_CONNECTIONS=true
    - LITELLM_CONNECTION_POOL_SIZE=20
    - HTTPX_HTTP2=1
    - POSTGRES_USER=litellmadmin
    - POSTGRES_PASSWORD=litellm_simple_pw_4567
    - POSTGRES_DB=litellm_db
    volumes:
    - litellm-db:/var/lib/postgresql/data
    networks:
    - llm_network
    healthcheck:
      test:
      - CMD-SHELL
      - pg_isready -U litellmadmin -d litellm_db
      interval: 10s
      timeout: 5s
      retries: 5
    dns: *id001
  litellm-redis:
    image: redis:8
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
    container_name: litellm-redis
    restart: always
    networks:
    - llm_network
    dns: *id001
  litellm-proxy:
    image: ghcr.io/berriai/litellm:main-stable
    container_name: litellm-proxy
    labels:
    - com.centurylinklabs.watchtower.enable=true
    env_file: .env
    restart: always
    ports:
    - 127.0.0.1:4000:4000
    volumes:
    - ./litellm-config.yaml:/app/config.yaml
    networks:
    - llm_network
    environment:
    - ENABLE_STREAMING_RESPONSE=true
    - STREAM_TIMEOUT=0
    - DEFAULT_MODELS_STREAM=true
    - LITELLM_PERSISTENT_CONNECTIONS=true
    - LITELLM_CONNECTION_POOL_SIZE=20
    - HTTPX_HTTP2=1
    - WEB_CONCURRENCY=4
    - LITELLM_WORKERS=4
    - ASYNCIO_PARALLELISM=100
    - DATABASE_URL=postgresql://litellmadmin:litellm_simple_pw_4567@litellm-db:5432/litellm_db
    - STORE_MODEL_IN_DB=True
    depends_on:
    - litellm-db
    - litellm-redis
    - ollama
    command:
    - --config
    - /app/config.yaml
    - --port
    - '4000'
    dns: *id001
  litellm-prometheus:
    image: prom/prometheus:latest
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
    container_name: litellm-prometheus
    restart: always
    volumes:
    - prometheus_data:/prometheus
    networks:
    - llm_network
    dns: *id001
  watchtower:
    image: containrrr/watchtower:latest
    container_name: watchtower
    restart: always
    volumes:
    - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - DOCKER_API_VERSION=1.44
      - ENABLE_STREAMING_RESPONSE=true
      - STREAM_TIMEOUT=0
      - DEFAULT_MODELS_STREAM=true
      - LITELLM_PERSISTENT_CONNECTIONS=true
      - LITELLM_CONNECTION_POOL_SIZE=20
      - HTTPX_HTTP2=1
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_LABEL_ENABLE=true
      - WATCHTOWER_SCHEDULE=0 0 3 * * *
      - TZ=America/New_York
    dns: *id001
volumes:
  ollama:
    external: true
  open-webui:
    external: true
  litellm-db:
    external: true
  prometheus_data:
    external: true
    name: litellm-prometheus
networks:
  llm_network:
    name: llm_network
    driver: bridge
  litellm_network:
    name: litellm_llm_network
    external: true
